<!DOCTYPE html>
<html lang="ru" class="football">

<head>

    <meta charset="utf-8">
    <meta name="author" content="Edwards, Allegro, Edwards75, Allegro75, Oleg Otkidach">
    <meta name="author" content="Олег Откидач">
    <meta name="description" content="История противостояний европейских футбольных клубов в рамках еврокубков.">
    <meta name="keywords" content="Футбол. Еврокубки. Европа. 
    Выбрать пару. История встреч.
    Личные встречи. Личные счета. vs. История игр. История противостояний.  
    Статистика. История. Результаты.
    Клубы. Суперклубы. Команды.
    Реал. Барселона. Ливерпуль. Манчестер Юнайтед. Арсенал. Бавария. Ювентус. Аякс.
    Лига чемпионов. Кубок чемпионов. Лига Европы. Кубок УЕФА. Кубок кубков. Суперкубок.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images/football_ball.svg" type="image/x-icon">
    <title>Выбрать пару. История встреч.</title>
    <link rel="stylesheet" href="stylesheets/football__body.css">
    <link rel="stylesheet" href="stylesheets/cap-wo-nav.css">
    <link rel="stylesheet" href="stylesheets/navigation.css">
    <link rel="stylesheet" href="stylesheets/captions.css">
    <link rel='stylesheet' href='stylesheets/selected-pair.css'>
    <link rel="stylesheet" href="stylesheets/donate.css">
    <link rel="stylesheet" href="stylesheets/footer.css">

</head>

<body class="football__body">
    <div class="football__background">

        <!-- Шапка -->
        <header class="cap">

            <div class="cap__site-title-stripe site-title-stripe">

                <a href="index.html" title="Лучшие клубы Европы за всю историю. Личные встречи. Сводная таблица.">
                    <img class="site-title-stripe__icon  site-title-stripe__icon_left"
                        src="images/football_ball_yellow.svg" alt="футбол">
                </a>

                <a href="index.html" title="Лучшие клубы Европы за всю историю. Личные встречи. Сводная таблица.">
                    <img class="site-title-stripe__icon  site-title-stripe__icon_right"
                        src="images/football_ball_yellow.svg" alt="футбол">
                </a>

                <div class="site-title-stripe__text">
                    <a href="index.html" title="Лучшие клубы Европы за всю историю. Личные встречи. Сводная таблица.">
                        Футбол <span class="site-title-stripe__text_delimiter">&#8226;</span>
                        Суперклубы <span class="site-title-stripe__text_delimiter">&#8226;</span>
                        Истории личных встреч <span class="site-title-stripe__text_delimiter">&#8226;</span>
                        Сводные таблицы
                    </a>
                </div>

            </div>

            <nav class="nav">
                <div class="nav__stripe football">
                    <!-- <div class="nav__stripe__title">
                    <a href="history36.html" title="Лучшие клубы Европы. Личные встречи. Сводная таблица">
                        ФУТБОЛ:
                    </a>
                    </div> -->
                    <ul class="nav__stripe__list">

                        
						<li class="nav__stripe__list__item select-pair">
                            <a href="selected-pair.php" title="Узнать историю встреч пары клубов нс свой выбор">
                                <div class="nav__icon select-pair">
                                    <!-- Сюда через css подставляется иконка -->
                                </div>
                                Выбрать пару
                            </a>
                        </li>

						<li class="nav__stripe__list__item  dropdown  current-season">
                            <a href="champ_league_current.html"
                                title="Фавориты еврокубков текущего сезона. Личные встречи. Сводная таблица">
                                <div class="nav__icon current">
                                </div>
                                ТЕКУЩИЙ СЕЗОН 
                                &#8729; Сводные таблицы
                            </a>

                            <ul class="nav__stripe__list__item__droplist">
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="archive/champ_league/cl_2022.html" title="Лига чемпионов 2021/2022. Ход турнира">
                                        ЛЧ 2021/2022. Ход турнира
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="champ_league_current.html" title="Фавориты Лиги чемпионов 2021/2022">
                                        Фавориты ЛЧ 2021/2022
                                    </a>
                                </li>                                
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="archive/euroleague/el_2022.html" title="Лига Европы 2021/2022. Ход турнира">
                                        ЛЕ 2021/2022. Ход турнира
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="euroleague_current.html" title="Фавориты Лиги Европы 2021/2022">
                                        Фавориты ЛЕ 2021/2022
                                    </a>
                                </li>                                
                            </ul>
                            
                        </li>

                        <li class="nav__stripe__list__item  dropdown  ussr">
                            <a href="russia.html"
                                title="Российские (и советские) клубы против европейских. Личные встречи. Сводная таблица">
                                <div class="nav__icon ussr">
                                    <!-- <img src="./images/ussr.png" alt="Россия/СССР" class="nav__icon ussr nav__icon_yellow">
                           <img src="./images/ussr_black.png" alt="Россия/СССР"
                              class="nav__icon ussr nav__icon_black"> -->
                                </div>
                                РОССИЯ / СССР
                            </a>
                            <ul class="nav__stripe__list__item__droplist">
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="russia.html" title="Российские клубы против европейских">
                                        Россия
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="ukraine.html" title="Украинские клубы против европейских">
                                        Украина
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="byelorussia.html" title="Белорусские клубы против европейских">
                                        Белоруссия
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="kazakhstan.html"
                                        title="Казахстанские клубы против европейских. Личные встречи. Сводная таблица">
                                        Казахстан
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav__stripe__list__item  dropdown  history">
                            <a href="history36.html"
                                title="Лучшие клубы Европы за всю историю. Личные встречи. Сводная таблица">
                                <div class="nav__icon history">
                                    <!-- <img src="./images/history_icon.png" alt="история"
                              class="nav__icon history nav__icon_yellow">
                           <img src="./images/history_icon_black.png" alt="история"
                              class="nav__icon history nav__icon_black"> -->
                                </div>
                                вся ИСТОРИЯ
                            </a>
                            <ul class="nav__stripe__list__item__droplist">
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="history.html" title="12 лучших клубов Европы за всю историю">
                                        <span class="figures-in-history-hrefs">12</span> клубов
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="history25.html" title="25 лучших клубов Европы за всю историю"> <span
                                            class="figures-in-history-hrefs">25</span> клубов </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="history36.html" title="36 лучших клубов Европы за всю историю"> <span
                                            class="figures-in-history-hrefs">36</span> клубов </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="winners.html" title="Все 22 победителя Лиги/кубка чемпионов всех лет">
                                        Победители ЛЧ
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="range.html" title="Список 100 лучших клубов Европы">
                                        Ранжир
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <li class="nav__stripe__list__item  decade">
                            <a href="decade.html"
                                title="24 лучших клуба десятилетия (2013-2022). Личные встречи. Сводная таблица">
                                <div class="nav__icon decade">
                                    <!-- <img src="./images/ten.png" alt="десятилетие" class="nav__icon decade nav__icon_yellow">
                                    <img src="./images/ten_black.png" alt="десятилетие"
                                    class="nav__icon decade nav__icon_black"> -->
                                </div>
                                Десятилетие
                            </a>
                        </li>

                        <li class="nav__stripe__list__item  range">
                            <a href="range.html" title="Список 100 лучших клубов в истории">
                                <div class="nav__icon range">
                                    <!-- Сюда через css подставляется иконка -->
                                </div>
                                Ранжир
                            </a>
                        </li>

                        

                        <li class="nav__stripe__list__item  dropdown  archive">

                            <a href="archive/champ_league/cl_2022.html" title="Еврокубки, история. Ход турниров">
                                <div class="nav__icon history"></div>
                                АРХИВ ТУРНИРОВ
                            </a>

                            <ul class="nav__stripe__list__item__droplist">
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="archive/champ_league/cl_2022.html"
                                        title="Лига/кубок чемпионов, история. Ход турниров">
                                        Лига чемпионов
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="archive/cup_win_cup/cwc_1999.html"
                                        title="Кубок кубков, история. Ход турниров">
                                        Кубок кубков
                                    </a>
                                </li>
                                <li class="nav__stripe__list__item__droplist__item">
                                    <a href="archive/euroleague/el_2022.html"
                                        title="Лига Европы / кубок УЕФА / кубок ярмарок, история. Ход турниров">
                                        Лига Европы
                                    </a>
                                </li>
                            </ul>

                        </li>
            </nav>

        </header> 
        
        <main>

            <!-- Заголовки -->
            <section class="captions">
                <h2 class="captions__h2">
                    ИСТОРИЯ ПРОТИВОСТОЯНИЙ ФУТБОЛЬНЫХ КЛУБОВ В ЕВРОКУБКАХ
                </h2>

                <p class="captions__explanation">
                    <span class="captions__explanation_circle">&#8226;</span>
                    Учитывались матчи только в рамках официальных европейских клубных турниров:
                    кубка чемпионов, лиги чемпионов, кубка кубков, кубка ярмарок, кубка УЕФА, лиги Европы, суперкубка
                    <span class="captions__explanation_circle">&#8226;</span>
                </p>

                <h1 class="captions__h1">
                    ПАРА КЛУБОВ НА ВАШ ВЫБОР
                </h1>

                <p class="captions__explanation">
                    <span class="captions__explanation_circle">&#8226;</span>                
                        Учтены матчи до 10.03.2022 включительно
                    <span class="captions__explanation_circle">&#8226;</span>
                </p>  
            </section>  
            
            <?

                require_once 'database/config/config.php';
                require_once 'database/config/connect.php';
                
                $conn = connect();

                // Список клубов:
                $clubsList = [];
                $allClubsIds = [0];
                $sql =
                    "SELECT * 
                    FROM `eurocups_clubs`
                ";
                $result = mysqli_query($conn, $sql);
                while ($item = mysqli_fetch_assoc($result)) {
                    $clubsList[$item['basicFullName']]["id"] = $item["id"];
                    $allClubsIds[] = $item["id"];
                }
                ksort($clubsList);
                $clubsList = ["" => ["id" => 0]] + $clubsList;
                // var_dump($clubsList);
                
                $firstClubDemoId = (isset($_GET['club_1']) && (in_array($_GET['club_1'], $allClubsIds))) ? $_GET['club_1'] : 165;
                $secondClubDemoId = (isset($_GET['club_2']) && (in_array($_GET['club_2'], $allClubsIds))) ? $_GET['club_2'] : 21;

            ?>
            
            <section class="pair-select">

                <form action="">

                    <label for="">
                        <span>Клуб 1:</span>
                        <select name="club_1">

                            <? foreach ($clubsList as $clubName_1 => $clubInfo_1): ?>
                                
                                <option value="<?=$clubInfo_1['id']?>" <?= ($firstClubDemoId == $clubInfo_1['id']) ? "selected" : "" ?>><?=$clubName_1?></option>

                            <? endforeach; ?>

                        </select>
                    </label>

                    <label for="">
                        <span>Клуб 2:</span>
                        <select name="club_2">

                            <? foreach ($clubsList as $clubName_2 => $clubInfo_2): ?>
                                
                                <option value="<?=$clubInfo_2['id']?>" <?= ($secondClubDemoId == $clubInfo_2['id']) ? "selected" : "" ?>><?=$clubName_2?></option>

                            <? endforeach; ?>

                        </select>
                    </label>

                    <button type="submit">Показать историю встреч</button>

                </form>

            </section>

            <?
                
                // $firstClubId = isset($_GET['club_1']) ? (int)($_GET['club_1']) : 0;
                // $secondClubId = isset($_GET['club_2']) ? (int)($_GET['club_2']) : 0;
                $firstClubId = $firstClubDemoId;
                $secondClubId = $secondClubDemoId;
                $haveIncorrectClubIds = false;
                if (($firstClubId <= 0) || ($secondClubId <= 0) || ($firstClubId == $secondClubId)) {
                    $haveIncorrectClubIds = true;
                }
                
                // Определяем данные клубов:
                $sql =
                    "SELECT * 
                    FROM `eurocups_clubs` 
                    WHERE id = {$firstClubId}
                ";
                $result = mysqli_query($conn, $sql);
                if ($item = mysqli_fetch_assoc($result)) {
                    $firstClubFullName = $item['basicFullName'];
                    $firstClubShortName = $item['shortName'];
                    $firstClubAltNames = $item['altNames'];
                    $firstClubCode = $item['code'];
                    $firstClubLogoClass = $item['CSSClass'];
                    $firstClubCountryEngCode = $item['countryEngCode'];
                }
                // var_dump($firstClubFullName);   
                
                $sql =
                    "SELECT * 
                    FROM `eurocups_clubs` 
                    WHERE id = {$secondClubId}
                ";
                $result = mysqli_query($conn, $sql);
                if ($item = mysqli_fetch_assoc($result)) {
                    $secondClubFullName = $item['basicFullName'];
                    $secondClubShortName = $item['shortName'];
                    $secondClubAltNames = explode(",", $item['altNames']);
                    $secondClubCode = $item['code'];
                    $secondClubLogoClass = $item['CSSClass'];
                    $secondClubCountryEngCode = $item['countryEngCode'];
                }                

                // Массив имён файлов с логотипами (нужен чтобы правильно добавлять к коду клуба ".png", ".svg" и т.п.)
                // $logoFiles = scandir("../images");
                $logoFiles = scandir("images");
                // echo '<pre>';
                // echo 'logoFiles:';
                // var_dump($logoFiles);

                // Имя файла с картинкой логотипа:
                $specialImages = [
                    "Akt" => "Akt_light.png",
                    "AuW" => "AuW_light.png",
                    "DuP" => "DuP_light.png",
                    "Mar" => "Mar_light.png",
                    "Mlm" => "Mlm_light.png",
                    "Nan" => "Nan_light.png",
                    "New" => "New_light.png",
                    "Not" => "Not_light.png",
                    "Prt" => "Prt_light.png",
                    "SpL" => "SpL_light.png",
                    "StL" => "StL_light.png",
                    "Zen" => "Zen_light.png",
                ];
                $firstLogoImageFile = $secondLogoImageFile = $firstFlagClass = $secondFlagClass = "";
                if ($firstClubCode != "") {
                    if (in_array($firstClubCode, array_keys($specialImages))) {
                        $firstLogoImageFile = $specialImages[$firstClubCode];
                    } else {        
                        if (in_array("{$firstClubCode}.png", $logoFiles)) {
                            $firstLogoImageFile = "{$firstClubCode}.png";
                        } elseif (in_array("{$firstClubCode}.svg", $logoFiles)) {
                            $firstLogoImageFile = "{$firstClubCode}.svg";
                        } elseif (in_array("{$firstClubCode}.jpg", $logoFiles)) {
                            $firstLogoImageFile = "{$firstClubCode}.jpg";
                        }
                    }
                } else {
                    $firstLogoImageFile = "flags/{$firstClubCountryEngCode}.png";
                    $firstFlagClass = " flag-image";
                }
                if ($secondClubCode != "") {
                    if (in_array($secondClubCode, array_keys($specialImages))) {
                        $secondLogoImageFile = $specialImages[$secondClubCode];
                    } else {    
                        if (in_array("{$secondClubCode}.png", $logoFiles)) {
                            $secondLogoImageFile = "{$secondClubCode}.png";
                        } elseif (in_array("{$secondClubCode}.svg", $logoFiles)) {
                            $secondLogoImageFile = "{$secondClubCode}.svg";
                        } elseif (in_array("{$secondClubCode}.jpg", $logoFiles)) {
                            $secondLogoImageFile = "{$secondClubCode}.jpg";
                        }
                    }
                } else {
                    $secondLogoImageFile = "flags/{$secondClubCountryEngCode}.png";
                    $secondFlagClass = " flag-image";
                }

                // var_dump($firstClubFullName,$firstClubShortName,$firstClubCode,$secondClubFullName,$secondClubShortName,$secondClubCode);
                $firstClubLogoClassToInsert = ($firstClubLogoClass != "") ? " {$firstClubLogoClass}" : "";
                $secondClubLogoClassToInsert = ($secondClubLogoClass != "") ? " {$secondClubLogoClass}" : "";

                // Определяем статистику:
                $sql =
                    "SELECT * 
                    FROM `matches` 
                    WHERE 
                        (
                                (
                                    firstClubId = '{$firstClubId}' 
                                    AND secondClubId = '{$secondClubId}'
                                ) 
                            OR 
                                (
                                    firstClubId = '{$secondClubId}' 
                                    AND secondClubId = '{$firstClubId}'
                                )
                        )
                    AND `score` != ''
                ";
                $result = mysqli_query($conn, $sql);
                $matchesArr = array();
                if (mysqli_num_rows($result) > 0) {
                    while ($row = mysqli_fetch_assoc($result)) {
                        $matchesArr[] = $row;
                    }
                }
                $noHistory = false;
                if (count($matchesArr) === 0) {
                    $noHistory = true;
                }
                // echo '<pre>';
                // var_dump($matchesArr);
                // echo '</pre>';

                // Про количество матчей:
                $matchesQuantity = count($matchesArr);
                $matchesWord = 'матчей';
                if (($matchesQuantity != 11) && (($matchesQuantity % 10) === 1)) {
                    $matchesWord = 'матч';
                } else if (
                    ((($matchesQuantity % 10) === 2) || (($matchesQuantity % 10) === 3) || (($matchesQuantity % 10) === 4)) &&
                    ($matchesQuantity != 12) &&
                    ($matchesQuantity != 13)  &&
                    ($matchesQuantity != 14)
                ) {
                    $matchesWord = 'матча';
                }
                
                // Про победы, ничьи, поражения:
                if (true) {
                    $firstVictories = 0;
                    $draws = 0;
                    for ($i = 0; $i < count($matchesArr); $i++) {
                        $draws += $matchesArr[$i]['fCDraw'];
                        if ($matchesArr[$i]['firstClubId'] == $firstClubId) {
                            $firstVictories += $matchesArr[$i]['fCVictory'];
                        } else {
                            $firstVictories += $matchesArr[$i]['fCLesion'];
                        }
                    }
                    $firstLesions = count($matchesArr) - $firstVictories - $draws;

                    $victoriesWord = 'побед';
                    if ($firstVictories === 1) {
                        $victoriesWord = 'победа';
                    } else if (($firstVictories >= 2) && ($firstVictories <= 4)) {
                        $victoriesWord = 'победы';
                    }

                    $drawsWord = 'ничьих';
                    if ($draws === 1) {
                        $drawsWord = 'ничья';
                    } else if (($draws >= 2) && ($draws <= 4)) {
                        $drawsWord = 'ничьи';
                    }

                    $lesionsWord = 'поражений';
                    if ($firstLesions === 1) {
                        $lesionsWord = 'поражение';
                    } else if (($firstLesions >= 2) && ($firstLesions <= 4)) {
                        $lesionsWord = 'поражения';
                    }

                    // Про разницу мячей:
                    $firstGoals = 0;
                    $secondGoals = 0;
                    for ($i = 0; $i < count($matchesArr); $i++) {
                        if ($matchesArr[$i]['firstClubId'] == $firstClubId) {
                            $firstGoals += $matchesArr[$i]['firstClubGoals'];
                            $secondGoals += $matchesArr[$i]['secondClubGoals'];
                        } else {
                            $firstGoals += $matchesArr[$i]['secondClubGoals'];
                            $secondGoals += $matchesArr[$i]['firstClubGoals'];
                        }
                    }
                }

                // Про ДУЭЛИ:
                if (true) {

                    // Массив дуэлей ($duelsArr):
                    $duelsArr = [];
                    foreach ($matchesArr as $curMatch) {
                        $duelFullIndicatorArr = [
                            "tourFinYear" => $curMatch["tourneyFinalYear"],
                            "tourneyStage" => $curMatch["tourneyStage"],
                        ];
                        $duelShortIndicator = serialize($duelFullIndicatorArr);
                        // if ( ! (isset($duelsArr[$duelShortIndicator])) ) {
                        $duelsArr[$duelShortIndicator][] = $curMatch;
                        // }
                    }
                    // echo '<pre>';
                    // var_dump($duelsArr);
                    // echo '</pre>';
                    // echo '<pre>';
                    // var_dump(array_keys($duelsArr));
                    // echo '</pre>';

                    // Сортируем массив дуэлей по датам и стадиям:
                    uksort($duelsArr, function ($a, $b) {
                        $a = unserialize($a);
                        $b = unserialize($b);
                        if ($a["tourFinYear"] < $b["tourFinYear"]) {
                            return -1;
                        } elseif ($a["tourFinYear"] > $b["tourFinYear"]) {
                            return 1;
                        } elseif ($a["tourFinYear"] == $b["tourFinYear"]) {
                            // Стандартный порядок стадий:
                            $stagesOrder = [
                                "Финал",
                                "1/2 финала",
                                "1/4 финала",
                                "группа2",
                                "1/8 финала",
                                "1/16 финала",
                                "группа",
                                "1/32 финала",
                                "1/64 финала",
                                "Раунд плей-офф",
                                "Третий квалификационный раунд",
                                "Третий отборочный раунд",
                                "2-й квалификационный раунд",
                                "Второй квалификационный раунд",
                                "Второй отборочный раунд",
                                "1-й квалификационный раунд",
                                "Первый квалификационный раунд",
                                "Первый отборочный раунд",
                                "Первый раунд",
                                "Квалификационный раунд",
                                "Отборочный раунд",
                                "Предварительный раунд, финал",
                                "Предварительный раунд, 1/2 финала",
                                "Предварительный раунд",
                            ];
                            if (array_search($a["tourneyStage"], $stagesOrder) < array_search($b["tourneyStage"], $stagesOrder)) {
                                return 1;
                            } else {
                                return -1;
                            }
                        }
                    });
                    // echo '<pre>';
                    // var_dump(array_keys($duelsArr));
                    // echo '</pre>';

                    // Число дуэлей:
                    $duelsNumber = count($duelsArr);
                    $duelsWord = 'дуэлей';
                    if (($duelsNumber != 11) && (($duelsNumber % 10) === 1)) {
                        $duelsWord = 'дуэль';
                    } else if (
                        ((($duelsNumber % 10) === 2) || (($duelsNumber % 10) === 3) || (($duelsNumber % 10) === 4)) &&
                        ($duelsNumber != 12) &&
                        ($duelsNumber != 13)  &&
                        ($duelsNumber != 14)
                    ) {
                        $duelsWord = 'дуэли';
                    }

                    // Исходы дуэлей:
                    if (true) {

                        // Нужны костыли для:
                        // - ДинамоК отбор против датчан, кажется, в районе 1994-го года в ЛЧ

                        $duelsResults = [];
                        foreach ($duelsArr as $duelInd => $curDuel) {

                            $curDuelInd = unserialize($duelInd);
                            // echo '<pre>';
                            // var_dump($curDuelInd);
                            // echo '</pre>';  

                            // Определение победителя дуэли для финалов:
                            if ($curDuelInd["tourneyStage"] === "Финал") {

                                if (count($curDuel) === 1) { // Если финальный матч один

                                    if ($curDuel[0]["penaltiesWinner"] != "") { // Если была серия пенальти
                                        if (($curDuel[0]["penaltiesWinner"] === $firstClubFullName) || ($curDuel[0]["penaltiesWinner"] === $firstClubShortName) || ($curDuel[0]["penaltiesWinner"] === $firstClubAltNames)) {
                                            $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                        } else {
                                            $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                        }
                                    } elseif ($curDuel[0]["fCVictory"] === "1") {
                                        if ($curDuel[0]["firstClubName"] === $firstClubFullName) {
                                            $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                        } else {
                                            $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                        }
                                    } elseif ($curDuel[0]["fCVictory"] === "0") {
                                        if ($curDuel[0]["firstClubName"] === $firstClubFullName) {
                                            $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                        } else {
                                            $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                        }
                                    }
                                } elseif (count($curDuel) === 2) { // Если финальных матчей в этом турнире два

                                    if (($curDuel[0]["penaltiesWinner"] != "") || ($curDuel[1]["penaltiesWinner"] != "")) { // Если была серия пенальти

                                        $penaltiesWinner = ($curDuel[0]["penaltiesWinner"] != "") ? $curDuel[0]["penaltiesWinner"] : $curDuel[1]["penaltiesWinner"];
                                        if ($penaltiesWinner === $firstClubFullName) {
                                            $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                        } else {
                                            $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                        }
                                    } else { // Если пенальти не было:

                                        // Если был доп. матч:
                                        if (($curDuel[0]["comments"] === "доп. матч") || ($curDuel[1]["comments"] === "доп. матч")) {

                                            // Номер доп. матча:
                                            $addMatchNum = ($curDuel[0]["comments"] === "доп. матч") ? 0 : 1;

                                            $fClubName = $curDuel[$addMatchNum]["firstClubName"];

                                            if ($curDuel[$addMatchNum]["fCVictory"] === "1") {

                                                if ($fClubName === $firstClubFullName) {
                                                    $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                                } else {
                                                    $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                                }
                                            } elseif ($curDuel[$addMatchNum]["fCLesion"] === "1") {

                                                if ($fClubName === $firstClubFullName) {
                                                    $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                                } else {
                                                    $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                                }
                                            }
                                        }

                                        // Если доп. матча не было:
                                        else {

                                            // Считаем голы:
                                            // Всего (за два матча) голов первой (по базе) команды в первом матче:
                                            $firstMatchFirstTeamTotalGoalsNumber = $curDuel[0]["firstClubGoals"] + $curDuel[1]["secondClubGoals"];
                                            // Всего (за два матча) голов ВТОРОЙ команды в первом матче:
                                            $firstMatchSECONDTeamTotalGoalsNumber = $curDuel[0]["secondClubGoals"] + $curDuel[1]["firstClubGoals"];

                                            if ($firstMatchFirstTeamTotalGoalsNumber !== $firstMatchSECONDTeamTotalGoalsNumber) { // Если можно выяснить победителя по числу голов в двух матчах

                                                $fClubName = $curDuel[0]["firstClubName"];

                                                if ($firstMatchFirstTeamTotalGoalsNumber > $firstMatchSECONDTeamTotalGoalsNumber) {

                                                    if ($fClubName === $firstClubFullName) {
                                                        $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                                    } else {
                                                        $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                                    }
                                                } elseif ($firstMatchFirstTeamTotalGoalsNumber < $firstMatchSECONDTeamTotalGoalsNumber) {

                                                    if ($fClubName === $firstClubFullName) {
                                                        $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                                    } else {
                                                        $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                                    }
                                                }
                                            } elseif ($firstMatchFirstTeamTotalGoalsNumber === $firstMatchSECONDTeamTotalGoalsNumber) { // Если число голов равное

                                                // Считаем голы на чужом поле:
                                                // Определяем номер матча на СВОЁМ поле для первой команды в первом матче:
                                                if ($curDuel[0]["home"] !== "neutral") {
                                                    if ($curDuel[0]["home"] === $curDuel[0]["firstClubName"]) {
                                                        $homeMatchNum = 0;
                                                    }
                                                } else { // Если первый матч на поле со статусом "neutral"
                                                    if ($curDuel[1]["home"] === $curDuel[0]["firstClubName"]) {
                                                        $homeMatchNum = 1;
                                                    }
                                                }

                                                $guestMatchNum = ($homeMatchNum === 0) ? 1 : 0;

                                                // Число гостевых голов первой команды первого матча:
                                                $firstTeamGuestGoals = $curDuel[$guestMatchNum]["secondClubGoals"];

                                                // Число гостевых голов второй команды первого матча:
                                                $secondTeamGuestGoals = $curDuel[$homeMatchNum]["secondClubGoals"];

                                                if ($firstTeamGuestGoals > $secondTeamGuestGoals) {

                                                    if ($curDuel[0]["firstClubName"] === $firstClubFullName) {
                                                        $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                                    } else {
                                                        $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                                    }
                                                } elseif ($firstTeamGuestGoals < $secondTeamGuestGoals) {

                                                    if ($curDuel[0]["firstClubName"] === $firstClubFullName) {
                                                        $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                                    } else {
                                                        $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            // Определение победителя дуэли для более ранних (чем финал) стадий:
                            else {

                                // Стандартный порядок стадий:
                                $stagesOrder = [
                                    "Финал",
                                    "1/2 финала",
                                    "1/4 финала",
                                    "группа2",
                                    "1/8 финала",
                                    "1/16 финала",
                                    "группа",
                                    "1/32 финала",
                                    "1/64 финала",
                                    "Раунд плей-офф",
                                    "Первый раунд",
                                    "Третий квалификационный раунд",
                                    "Третий отборочный раунд",
                                    "2-й квалификационный раунд",
                                    "Второй квалификационный раунд",
                                    "Второй отборочный раунд",
                                    "1-й квалификационный раунд",
                                    "Первый квалификационный раунд",
                                    "Первый отборочный раунд",                    
                                    "Квалификационный раунд",
                                    "Отборочный раунд",
                                    "Предварительный раунд, финал",
                                    "Предварительный раунд, 1/2 финала",
                                    "Предварительный раунд",
                                ];
                                // Порядок стадий в ЛЧ с 92 по 94 отличается:  
                                if (($curDuelInd["tourFinYear"] >= 1992) && ($curDuelInd["tourFinYear"] <= 1994)) {
                                    $stagesOrder[4] = "группа";
                                    $stagesOrder[5] = "1/8 финала";
                                    $stagesOrder[6] = "1/16 финала";
                                }

                                // Массив более высоких (по отношению к ракссматриваемой дуэли) стадий турнира $higherStages:
                                $stageInd = array_search($curDuelInd["tourneyStage"], $stagesOrder);
                                $higherStages = array_slice($stagesOrder, 0, $stageInd);
                                // echo '<pre>';
                                // var_dump($higherStages);
                                // echo '</pre>';

                                // Выясняем, есть ли упоминания о клубах на более высоких стадиях турнира:
                                $highStagesWQuotes = array_map(function ($a) {
                                    return "'{$a}'";
                                }, $higherStages);
                                $higherStagesStr = implode(",", $highStagesWQuotes);
                                $tourName = $curDuel[0]["tourneyTitle"];
                                $sql =
                                    "SELECT COUNT(*) AS `count`
                                    FROM `matches` 
                                    WHERE `tourneyStage` IN ({$higherStagesStr})
                                    AND `tourneyFinalYear` = {$curDuelInd["tourFinYear"]}
                                    AND `tourneyTitle` = '{$tourName}'
                                    AND
                                        (
                                            `firstClubId` = {$firstClubId}
                                            OR `secondClubId` = {$firstClubId}
                                        )
                                ";
                                // echo '<pre>';
                                // var_dump($sql);
                                // echo '</pre>';  

                                $res = mysqli_query($conn, $sql);
                                if ($row = mysqli_fetch_assoc($res)) {
                                    $hasFirstClubAdvance = ($row["count"] > 0) ? true : false;
                                }

                                $sql =
                                    "SELECT COUNT(*) AS `count`
                                    FROM `matches` 
                                    WHERE `tourneyStage` IN ({$higherStagesStr})
                                    AND `tourneyFinalYear` = {$curDuelInd["tourFinYear"]}
                                    AND `tourneyTitle` = '{$tourName}'
                                    AND
                                        (
                                            `firstClubId` = {$secondClubId}
                                            OR `secondClubId` = {$secondClubId}
                                        )
                                ";
                                $res = mysqli_query($conn, $sql);
                                if ($row = mysqli_fetch_assoc($res)) {
                                    $hasSecondClubAdvance = ($row["count"] > 0) ? true : false;
                                }

                                if ($hasFirstClubAdvance && !$hasSecondClubAdvance) {
                                    $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                } else if (!$hasFirstClubAdvance && $hasSecondClubAdvance) {
                                    $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                } else if ($hasFirstClubAdvance && $hasSecondClubAdvance) {
                                    $duelsResults[$duelInd]["result"] = "draw";
                                }
                                // В случае, если обе команды не продвинулись в турнире, надо проверять участие в ЛЕ:
                                else {
                                    $sql =
                                        "SELECT COUNT(*) AS `count`
                                        FROM `matches` 
                                        WHERE `tourneyStage` IN ({$higherStagesStr})
                                        AND `tourneyFinalYear` = {$curDuelInd["tourFinYear"]}
                                        AND `tourneyTitle` IN ('Кубок УЕФА', 'Лига Европы')
                                        AND
                                            (
                                                `firstClubId` = {$firstClubId}
                                                OR `secondClubId` = {$firstClubId}
                                            )
                                    ";
                                    $res = mysqli_query($conn, $sql);
                                    if ($row = mysqli_fetch_assoc($res)) {
                                        $hasFCEuroLeagueAdvance = ($row["count"] > 0) ? true : false;
                                    }
                                    if ($hasFCEuroLeagueAdvance) {
                                        $duelsResults[$duelInd]["result"] = "firstClubVictory";
                                    } else {
                                        $sql =
                                            "SELECT COUNT(*) AS `count`
                                            FROM `matches` 
                                            WHERE `tourneyStage` IN ({$higherStagesStr})
                                            AND `tourneyFinalYear` = {$curDuelInd["tourFinYear"]}
                                            AND `tourneyTitle` IN ('Кубок УЕФА', 'Лига Европы')
                                            AND
                                                (
                                                    `firstClubId` = {$secondClubId}
                                                    OR `secondClubId` = {$secondClubId}
                                                )
                                        ";
                                        $res = mysqli_query($conn, $sql);
                                        if ($row = mysqli_fetch_assoc($res)) {
                                            // $duelsResults[$duelInd]["result"] = ($row["count"] > 0) ? "secondClubVictory" : "draw";
                                            if($row["count"] > 0) {
                                                $duelsResults[$duelInd]["result"] = "secondClubVictory";
                                            } else {
                                                if (($curDuelInd["tourFinYear"] == 2022) && (($curDuelInd["tourneyStage"] == "1/8 финала") || ($curDuelInd["tourneyStage"] == "1/16 финала"))) { // для незавершенных дуэлей 2021/2022
                                                    $duelsResults[$duelInd]["result"] = "notFinished";
                                                } else {
                                                    $duelsResults[$duelInd]["result"] = "draw";
                                                } 
                                            }
                                        }
                                    }
                                }
                            }

                            // Число побед и поражений в дуэлях во всей истории встреч:
                            $firstClubDuelsVictories = $firstClubDuelsLesions = $duelDraws = $notFinishedDuels = 0;
                            foreach ($duelsResults as $duelData) {
                                if ($duelData["result"] === "firstClubVictory") {
                                    $firstClubDuelsVictories++;
                                } elseif ($duelData["result"] === "secondClubVictory") {
                                    $firstClubDuelsLesions++;
                                } elseif ($duelData["result"] === "draw") {
                                    $duelDraws++;
                                } elseif ($duelData["result"] === "notFinished") {
                                    $notFinishedDuels++;
                                }
                            }

                            $duelsVictoriesWord = 'побед';
                            if ($firstClubDuelsVictories === 1) {
                                $duelsVictoriesWord = 'победа';
                            } else if (($firstClubDuelsVictories >= 2) && ($firstClubDuelsVictories <= 4)) {
                                $duelsVictoriesWord = 'победы';
                            }

                            $duelsLesionsWord = 'поражений';
                            if ($firstClubDuelsLesions === 1) {
                                $duelsLesionsWord = 'поражение';
                            } else if (($firstClubDuelsLesions >= 2) && ($firstClubDuelsLesions <= 4)) {
                                $duelsLesionsWord = 'поражения';
                            }
                        }

                        // echo '<pre>';
                        // var_dump($duelsResults);
                        // echo '</pre>';

                        $duelsDrawsElement = "";
                        if ($duelDraws > 0) {

                            $drawDuelsWord = 'дуэлей';
                            if (($duelDraws != 11) && (($duelDraws % 10) === 1)) {
                                $drawDuelsWord = 'дуэль';
                            } else if (($duelDraws != 12) && ($duelDraws != 13)  && ($duelDraws != 14) && ((($duelDraws % 10) === 2)) || (($duelDraws % 10) === 3) || (($duelDraws % 10) === 4)) {
                                $drawDuelsWord = 'дуэли';
                            }

                            $groupWord = 'группе';
                            $defineWord = 'выявила';
                            if ($duelDraws > 1) {
                                $groupWord = 'группах';
                                $defineWord = 'выявили';
                            }

                            $duelsDrawsElement = "<p>{$duelDraws} {$drawDuelsWord} в {$groupWord} не {$defineWord} победителя</p>";
                        }

                        $notFinishedDuelsElement = "";
                        if ($notFinishedDuels == 1) {
                            $notFinishedDuelsElement = "<p>1 дуэль не завершена</p>";
                        }

                    }
                }

                mysqli_close($conn);  
                
                if ($noHistory) {
                    $duelsText = "<p>В еврокубках не встречались</p>";
                } else {
                    $duelsText = "<p>{$duelsNumber} {$duelsWord}:</p>
                    <p><span class='duels-score'>{$firstClubDuelsVictories}</span> {$duelsVictoriesWord} в дуэлях, <span class='duels-score'>{$firstClubDuelsLesions}</span> {$duelsLesionsWord}</p>
                    {$duelsDrawsElement}{$notFinishedDuelsElement}";
                }
                
                $metaKeywordsContent = "";
                if ($firstClubShortName === $firstClubFullName) {
                    $metaKeywordsContent = "{$metaKeywordsContent}{$firstClubShortName}.";
                } else {
                    $metaKeywordsContent = "{$metaKeywordsContent}{$firstClubShortName}. {$firstClubFullName}.";
                }
                if ($secondClubShortName === $secondClubFullName) {
                    $metaKeywordsContent = "{$metaKeywordsContent} {$secondClubShortName}.";
                } else {
                    $metaKeywordsContent = "{$metaKeywordsContent} {$secondClubShortName}. {$secondClubFullName}.";
                } 
                
                echo "
                    <div class='additional-table'>
                        <img src='../images/{$firstLogoImageFile}' alt='{$firstClubShortName}' class='football-logo-table logo-left{$firstClubLogoClassToInsert}{$firstFlagClass}'>
                        <img src='../images/{$secondLogoImageFile}' alt='{$secondClubShortName}' class='football-logo-table logo-right{$secondClubLogoClassToInsert}{$secondFlagClass}'>
                        <h1>{$firstClubFullName} - {$secondClubFullName}</h1>
                        <p>{$matchesQuantity} {$matchesWord}:</p>
                        <p>{$firstVictories} {$victoriesWord}, {$draws} {$drawsWord}, {$firstLesions} {$lesionsWord}</p>
                        <p>Разница мячей: {$firstGoals} - {$secondGoals}</p>
                
                
                        <div class='duels-text'>
                            {$duelsText}
                        </div>
                
                        <table class='add-table'>
                            <tr>
                                <td>№</td>
                                <td>Поле</td>
                                <td>Счёт</td>
                                <td>Год</td>
                                <td>Турнир</td>
                                <td>Стадия</td>
                            </tr>";
                
                    // echo '<pre>';
                    // var_dump($duelsArr);
                    // echo '</pre>';

                    // Сортируем матчи внутри дуэлей по дате:
                    foreach ($duelsArr as &$duelData) {
                        usort($duelData, function($a, $b) {
                            return (strtotime($a["matchDate"]) > strtotime($b["matchDate"])) ? 1 : -1;
                        });
                    }
                    unset($duelData);

                    $output = "";
                    $matchNumber = 1;

                    $stagesToShowArr = [
                        "Финал" => "ФИНАЛ",
                        "1/2 финала" => "1/2",
                        "1/4 финала" => "1/4",
                        "группа2" => "группа2",
                        "1/8 финала" => "1/8",
                        "1/16 финала" => "1/16",
                        "группа" => "группа",
                        "1/32 финала" => "1/32",
                        "1/64 финала" => "1/64",
                        "Раунд плей-офф" => "отбор",
                        "Третий квалификационный раунд" => "отбор",
                        "Третий отборочный раунд" => "отбор",
                        "2-й квалификационный раунд" => "отбор",
                        "Второй квалификационный раунд" => "отбор",
                        "Второй отборочный раунд" => "отбор",
                        "1-й квалификационный раунд" => "отбор",
                        "Первый квалификационный раунд" => "отбор",
                        "Первый отборочный раунд" => "отбор",
                        "Первый раунд" => "отбор",
                        "Квалификационный раунд" => "отбор",
                        "Отборочный раунд" => "отбор",
                        "Предварительный раунд, финал" => "отбор",
                        "Предварительный раунд, 1/2 финала" => "отбор",
                        "Предварительный раунд" => "отбор",
                    ];

                    foreach ($duelsArr as $duelSerialInd => $duelData) {

                        $duelResultClass = "win";
                        $duelResRow = 
                        "<tr class='duel-result duel-win' title='Дуэль выше выиграна'>
                            <td colspan='5'>
                            </td>
                            <td>
                                &#9650;
                            </td>
                        </tr>";
                        if ($duelsResults[$duelSerialInd]["result"] === "secondClubVictory") {
                            $duelResultClass = "loose";
                            $duelResRow = "
                            <tr class='duel-result duel-loose' title='Дуэль выше проиграна'>
                                <td colspan='5'>
                                </td>
                                <td>
                                    &#9660;
                                </td>
                            </tr>";
                        } elseif ($duelsResults[$duelSerialInd]["result"] === "draw") {
                            $duelResultClass = "draw";
                            $duelResRow = "
                            <tr class='duel-result duel-draw'
                            title='Дуэль выше не выявила победителя'>
                                <td colspan='5'>
                                </td>
                                <td>
                                    <span class='yellow-circle'>
                                        &#9679;
                                    </span>
                                </td>
                            </tr>";
                        } elseif ($duelsResults[$duelSerialInd]["result"] === "notFinished") {
                            $duelResultClass = "";
                            $duelResRow = "";
                        }
                        // $duelInd = unserialize($duelSerialInd);

                        $finalClass = "";
                        if ($duelData[0]["tourneyStage"] === "Финал") {
                            $finalClass = " final";
                        }        

                        foreach ($duelData as $curMatch) {

                            $output = "{$output}<tr class='duel-{$duelResultClass}{$finalClass}'>";

                            $output = "{$output}<td class='number-of-match'>{$matchNumber}</td>";
                            $matchNumber++;

                            $homeCell = "<td title='дома'>д</td>";
                            if ($curMatch["home"] === "neutral") {
                                $homeCell = "<td title='нейтральное поле'>н</td>";
                            } elseif ( ($curMatch["home"] === $secondClubFullName) || ($curMatch["home"] === $secondClubShortName) || (in_array($curMatch["home"], $secondClubAltNames)) ) {
                                $homeCell = "<td title='в гостях'>г</td>";
                            }
                            $output = "{$output}{$homeCell}";

                            $firstClubGoals = $secondClubGoals = 0;
                            if ($curMatch["firstClubId"] == $firstClubId) {
                                $firstClubGoals = $curMatch["firstClubGoals"];
                                $secondClubGoals = $curMatch["secondClubGoals"];
                            } else {
                                $firstClubGoals = $curMatch["secondClubGoals"];
                                $secondClubGoals = $curMatch["firstClubGoals"];                
                            }

                            // Доп. инфо по матчу. (Нужно ещё доработать на случай жребия и двух событий одновременно (жребий и доп. матч. например))
                            $addText = "";
                            if ($curMatch["hadEfficientAddTime"] == 1) {
                                $addText = "<br><span class='add-time-text'>(доп. время)</span>";
                            }
                            if ($curMatch["hadPenalties"] == 1) {
                                $victOrLes = "победа";
                                if ($duelsResults[$duelSerialInd]["result"] === "secondClubVictory") {
                                    $victOrLes = "поражение";
                                }
                                $addText = "<br><span class='penalty-text'>({$victOrLes}<br>по пенальти)</span>";
                            }
                            if ($curMatch["comments"] === "доп. матч") {
                                $addText = "<br><span class='add-match-text'>(доп. матч)</span>";
                            }
                            if (($curMatch["comments"] === "тех. победа") && ($curMatch["firstClubId"] == $firstClubId)) {
                                $addText = "<br><span class='add-time-text'>(тех. победа)</span>";
                            } elseif (($curMatch["comments"] === "тех. победа") && ($curMatch["firstClubId"] == $secondClubId)) {
                                $addText = "<br><span class='add-time-text'>(тех. поражение)</span>";
                            } elseif (($curMatch["comments"] === "тех. поражение") && ($curMatch["firstClubId"] == $firstClubId)) {
                                $addText = "<br><span class='add-time-text'>(тех. поражение)</span>";
                            } elseif (($curMatch["comments"] === "тех. поражение") && ($curMatch["firstClubId"] == $secondClubId)) {
                                $addText = "<br><span class='add-time-text'>(тех. победа)</span>";
                            }

                            $output = "{$output}<td>{$firstClubGoals} : {$secondClubGoals}{$addText}</td>";

                            $year = $curMatch["year"];
                            $output = "{$output}<td>{$year}</td>";

                            $tourney = $curMatch["tourneyTitle"];
                            $output = "{$output}<td>{$tourney}</td>";

                            $stageToShow = $stagesToShowArr[$curMatch["tourneyStage"]];
                            $output = "{$output}<td>{$stageToShow}</td>";

                        }



                        $output = "{$output}</tr>";
                        $output = "{$output}{$duelResRow}";

                    }

                    echo $output;

                    echo 
                    "   </table>
                
                    </div>"    

            ?>

        <script src="../scripts/small-tables/add_hrefs.js"></script>  

        </main>

        <div class="donate">
            <p>Поддержите проект!</p>
            <p>Подарите 50 рублей (или любую другую сумму):</p>
        </div>
        <iframe
            src="https://money.yandex.ru/quickpay/shop-widget?writer=seller&amp;targets=%D0%BD%D0%B0%20%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D1%83%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0&amp;targets-hint=&amp;default-sum=50&amp;button-text=13&amp;payment-type-choice=on&amp;mobile-payment-type-choice=on&amp;hint=&amp;successURL=https%3A%2F%2Fallegro75.github.io%2Fgithub.io%2F&amp;quickpay=shop&amp;account=410011017638757"
            allowtransparency="true" scrolling="no" width="100%" height="222" frameborder="0">
        </iframe>
        
        <footer>
            <p>
                С вопросами и предложениями обращайтесь по E-mail: otkidach75@yandex.ru
            </p>
        </footer>        

    </div>
</body>
</html>
